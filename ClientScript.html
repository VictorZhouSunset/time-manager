<script>
// Function to display a status message
function updateStatus(message, isError = false) {
  const statusDiv = document.getElementById('statusMessage');
  statusDiv.textContent = message;
  statusDiv.style.color = isError ? 'red' : 'green';
}

// Function to add a new project
function handleAddProject() {
  const name = document.getElementById('projectName').value;
  const description = document.getElementById('projectDescription').value;
  const expectTimeSpent = document.getElementById('projectExpectTimeSpent').value;

  if (!name || !expectTimeSpent) {
    updateStatus('Project Name and Expected Time are required!', true);
    return;
  }
  
  const projectData = {
    name: name,
    description: description,
    expectTimeSpent: parseFloat(expectTimeSpent),
    status: 'Not yet started'
  };

  console.log("Adding project with data:", projectData);
  updateStatus('Adding project...');
  google.script.run
    .withSuccessHandler(function(response) {
      console.log("Add project response:", response);
      if (response && response.success) {
        console.log("Project added successfully:", response.data);
        updateStatus('Project added successfully!');
        document.getElementById('projectName').value = '';
        document.getElementById('projectDescription').value = '';
        document.getElementById('projectExpectTimeSpent').value = '';
        loadProjects();
      } else {
        console.log("Error in add project response:", response);
        updateStatus('Error adding project: ' + (response && response.error ? response.error : 'Unknown error'), true);
      }
    })
    .withFailureHandler(function(error) {
      console.error("Failed to add project:", error);
      updateStatus('Failed to add project: ' + (error ? error.message : 'Unknown error'), true);
    })
    .core_addProject(projectData);
}

// Function to load all projects
function loadProjects() {
  const projectsListDiv = document.getElementById('projectsList');
  projectsListDiv.innerHTML = '<p>Loading projects...</p>';

  google.script.run
    .withSuccessHandler(function(response) {
      console.log("Projects response:", response);
      if (response && response.success && response.data) {
        console.log("Projects data:", response.data);
        if (response.data.length === 0) {
          projectsListDiv.innerHTML = '<p>No projects found. Add one!</p>';
          return;
        }

        const ul = document.createElement('ul');
        response.data.forEach(function(project) {
          console.log("Processing project:", project);
          const li = document.createElement('li');
          li.innerHTML = `
            <strong>${project.name}</strong>
            ${project.description ? `<br>${project.description}` : ''}
            <br>Status: ${project.status}
            <br>Expected Time: ${project.expectTimeSpent}h
            ${project.totalTimeSpent ? `<br>Time Spent: ${project.totalTimeSpent}h` : ''}
            <button onclick="loadTasks()">View Tasks</button>
            <button onclick="deleteProject('${project.projectId}')">Delete</button>
          `;
          ul.appendChild(li);
        });
        projectsListDiv.innerHTML = '';
        projectsListDiv.appendChild(ul);
      } else {
        console.log("Error in projects response:", response);
        projectsListDiv.innerHTML = '<p>Error loading projects: ' + (response && response.error ? response.error : 'Unknown error') + '</p>';
      }
    })
    .withFailureHandler(function(error) {
      console.error("Failed to load projects:", error);
      projectsListDiv.innerHTML = '<p>Failed to load projects: ' + (error ? error.message : 'Unknown error') + '</p>';
    })
    .core_getAllProjects();
}

// Function to load all tasks
function loadTasks() {
  const tasksListDiv = document.getElementById('tasksList');
  tasksListDiv.innerHTML = '<p>Loading tasks...</p>';

  google.script.run
    .withSuccessHandler(function(response) {
      if (response && response.success && response.data) {
        const tasks = response.data;
        
        if (tasks.length === 0) {
          tasksListDiv.innerHTML = '<p>No tasks found.</p>';
          return;
        }

        const ul = document.createElement('ul');
        tasks.forEach(function(task) {
          const li = document.createElement('li');
          li.innerHTML = `
            <strong>${task.name}</strong>
            ${task.description ? `<br>${task.description}` : ''}
            <br>Status: ${task.status}
            <br>Expected Time: ${task.expectTimeSpent}h
            ${task.totalTimeSpent ? `<br>Time Spent: ${task.totalTimeSpent}h` : ''}
            <button onclick="deleteTask('${task.taskId}')">Delete</button>
          `;
          ul.appendChild(li);
        });
        tasksListDiv.innerHTML = '';
        tasksListDiv.appendChild(ul);
      } else {
        tasksListDiv.innerHTML = '<p>Error loading tasks: ' + (response && response.error ? response.error : 'Unknown error') + '</p>';
      }
    })
    .withFailureHandler(function(error) {
      tasksListDiv.innerHTML = '<p>Failed to load tasks: ' + (error ? error.message : 'Unknown error') + '</p>';
    })
    .core_getAllTasks();
}

// Function to load calendar events
function loadEvents() {
  const eventsListDiv = document.getElementById('eventsList');
  eventsListDiv.innerHTML = '<p>Loading events...</p>';

  google.script.run
    .withSuccessHandler(function(response) {
      if (response && response.success && response.data) {
        if (response.data.length === 0) {
          eventsListDiv.innerHTML = '<p>No calendar events found.</p>';
          return;
        }

        const ul = document.createElement('ul');
        response.data.forEach(function(event) {
          const li = document.createElement('li');
          li.innerHTML = `
            <strong>${event.name}</strong>
            ${event.description ? `<br>${event.description}` : ''}
            <br>Start: ${new Date(event.eventStart).toLocaleString()}
            <br>End: ${new Date(event.eventEnd).toLocaleString()}
            <button onclick="deleteEvent('${event.eventId}')">Delete</button>
          `;
          ul.appendChild(li);
        });
        eventsListDiv.innerHTML = '';
        eventsListDiv.appendChild(ul);
      } else {
        eventsListDiv.innerHTML = '<p>Error loading events: ' + (response && response.error ? response.error : 'Unknown error') + '</p>';
      }
    })
    .withFailureHandler(function(error) {
      eventsListDiv.innerHTML = '<p>Failed to load events: ' + (error ? error.message : 'Unknown error') + '</p>';
    })
    .core_getAllEvents();
}

// Function to delete a project
function deleteProject(projectId) {
  if (!confirm('Are you sure you want to delete this project? This will also delete all associated tasks and events.')) {
    return;
  }

  google.script.run
    .withSuccessHandler(function(response) {
      if (response && response.success) {
        updateStatus('Project deleted successfully!');
        loadProjects();
        loadTasks(); // Clear tasks list
      } else {
        updateStatus('Error deleting project: ' + (response && response.error ? response.error : 'Unknown error'), true);
      }
    })
    .withFailureHandler(function(error) {
      updateStatus('Failed to delete project: ' + (error ? error.message : 'Unknown error'), true);
    })
    .core_deleteProject(projectId);
}

// Function to delete a task
function deleteTask(taskId) {
  if (!confirm('Are you sure you want to delete this task?')) {
    return;
  }

  google.script.run
    .withSuccessHandler(function(response) {
      if (response && response.success) {
        updateStatus('Task deleted successfully!');
        loadTasks(); // Reload tasks
      } else {
        updateStatus('Error deleting task: ' + (response && response.error ? response.error : 'Unknown error'), true);
      }
    })
    .withFailureHandler(function(error) {
      updateStatus('Failed to delete task: ' + (error ? error.message : 'Unknown error'), true);
    })
    .core_deleteTask(taskId);
}

// Function to delete an event
function deleteEvent(eventId) {
  if (!confirm('Are you sure you want to delete this event?')) {
    return;
  }

  google.script.run
    .withSuccessHandler(function(response) {
      if (response && response.success) {
        updateStatus('Event deleted successfully!');
        loadEvents();
      } else {
        updateStatus('Error deleting event: ' + (response && response.error ? response.error : 'Unknown error'), true);
      }
    })
    .withFailureHandler(function(error) {
      updateStatus('Failed to delete event: ' + (error ? error.message : 'Unknown error'), true);
    })
    .core_deleteEvent(eventId);
}

// Load initial data when the page loads
document.addEventListener('DOMContentLoaded', function() {
  loadProjects();
  loadTasks();
  loadEvents();
});
</script> 